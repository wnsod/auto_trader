import random
from typing import List, Tuple, Optional

class PersonaEngine:
    """
    AI ìºë¦­í„°ì˜ í–‰ë™/ê°ì •/ëŒ€ì‚¬ë¥¼ ê²°ì •í•˜ëŠ” íŽ˜ë¥´ì†Œë‚˜ ì—”ì§„
    âš ï¸ ì£¼ì˜: íˆ¬ìžë¥¼ ê¶Œìœ í•˜ê±°ë‚˜ ë…ë ¤í•˜ëŠ” í‘œí˜„ì€ ë²•ì  ë¬¸ì œê°€ ë  ìˆ˜ ìžˆìœ¼ë¯€ë¡œ ì—„ê²©ížˆ ë°°ì œí•©ë‹ˆë‹¤.
    ì˜¤ì§ 'í˜„í™©', 'ìƒíƒœ', 'ì‹œìŠ¤í…œ íŒë‹¨ ê²°ê³¼'ë§Œì„ ê°ê´€ì ìœ¼ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.
    """
    
    def __init__(self):
        # ìƒí™©ë³„ ëŒ€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ (Compliance ì¤€ìˆ˜ ë²„ì „)
        self.SCRIPTS = {
            "win_big": [
                "ëª©í‘œ ìˆ˜ìµë¥ ì„ ì´ˆê³¼ ë‹¬ì„±í•˜ì—¬ ì´ìµ ì‹¤í˜„ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ðŸ’°",
                "ì„¤ì •ëœ ì „ëžµì— ë”°ë¼ ê³ ìˆ˜ìµ êµ¬ê°„ì—ì„œ ë§¤ë„ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.",
                "ì‹œìŠ¤í…œ íŒë‹¨ ê²°ê³¼, ì˜ˆì¸¡ëœ ìƒìŠ¹í­ì„ ëª¨ë‘ ë°˜ì˜í•˜ì—¬ ì²­ì‚°í–ˆìŠµë‹ˆë‹¤.",
                "ëˆ„ì  ìˆ˜ìµë¥  ê°œì„ ì— ìœ ì˜ë¯¸í•œ ê±°ëž˜ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ðŸ“ˆ",
                "ë³€ë™ì„± ëŒíŒŒ ì „ëžµì´ ìœ íš¨í•˜ê²Œ ìž‘ë™í•˜ì—¬ ìˆ˜ìµ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
            ],
            "win_small": [
                "ëª©í‘œ êµ¬ê°„ ë„ë‹¬ë¡œ ì´ìµ ì‹¤í˜„í–ˆìŠµë‹ˆë‹¤. âœ…",
                "ë‹¨ê¸° íŠ¸ë ˆì´ë”© ë¡œì§ì— ë”°ë¼ ìˆ˜ìµ êµ¬ê°„ì—ì„œ ì²­ì‚° ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                "ë¦¬ìŠ¤í¬ ëŒ€ë¹„ ë³´ìƒ ë¹„ìœ¨(RR)ì´ ì¶©ì¡±ë˜ì–´ ë§¤ë§¤ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.",
                "ì•ˆì •ì ì¸ í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë¦¬ë¥¼ ìœ„í•´ ì´ìµì„ í™•ì •í–ˆìŠµë‹ˆë‹¤.",
                "ì‹œìŠ¤í…œ ê·œì¹™ì— ì˜ê±°, ìˆ˜ìµ êµ¬ê°„ì—ì„œ í¬ì§€ì…˜ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤."
            ],
            "loss_cut": [
                "ë¦¬ìŠ¤í¬ í—ˆìš© í•œë„ë¥¼ ì´ˆê³¼í•˜ì—¬ ì†ì ˆë§¤(Stop Loss)ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ðŸ›¡ï¸",
                "ì¶”ì„¸ ì´íƒˆì´ ê°ì§€ë˜ì–´ ìžì‚° ë³´í˜¸ë¥¼ ìœ„í•´ ë§¤ë„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.",
                "ì†ì‹¤ ìµœì†Œí™” ì›ì¹™ì— ë”°ë¼ í¬ì§€ì…˜ì„ ì¡°ê¸°ì— ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤.",
                "ì‹œìŠ¤í…œì˜ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ëª¨ë“ˆì´ ìž‘ë™í•˜ì—¬ ë°©ì–´ì  ë§¤ë„ë¥¼ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.",
                "í•˜ë½ ë³€ë™ì„± í™•ëŒ€ ê°ì§€ë¡œ í¬ì§€ì…˜ì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤."
            ],
            "holding_profit": [
                "í˜„ìž¬ í¬ì§€ì…˜ì´ ìˆ˜ìµ êµ¬ê°„ì— ìœ„ì¹˜í•˜ê³  ìžˆìŠµë‹ˆë‹¤. ðŸ“ˆ",
                "ìƒìŠ¹ ì¶”ì„¸ê°€ ìœ ì§€ë˜ê³  ìžˆì–´ í¬ì§€ì…˜ì„ ìœ ì§€ ì¤‘ìž…ë‹ˆë‹¤.",
                "ì•„ì§ ëª©í‘œ ë§¤ë„ ì‹œê·¸ë„ì´ ë°œìƒí•˜ì§€ ì•Šì•„ ë³´ìœ  ì¤‘ìž…ë‹ˆë‹¤.",
                "ì§€í‘œìƒ ì¶”ê°€ ìƒìŠ¹ ì—¬ë ¥ì´ ê´€ì¸¡ë˜ì–´ ì¶”ì„¸ë¥¼ ì¶”ì  ì¤‘ìž…ë‹ˆë‹¤.",
                "ê¸ì •ì ì¸ ë³€ë™ì„±ì´ ì§€ì†ë˜ê³  ìžˆìŠµë‹ˆë‹¤."
            ],
            "holding_loss": [
                "í˜„ìž¬ í¬ì§€ì…˜ì´ ì†ì‹¤ êµ¬ê°„ì— ì§„ìž…í–ˆìŠµë‹ˆë‹¤. ëª¨ë‹ˆí„°ë§ ê°•í™” ì¤‘ìž…ë‹ˆë‹¤. âš ï¸",
                "ì¼ì‹œì  ì¡°ì •ì¸ì§€ ì¶”ì„¸ ì´íƒˆì¸ì§€ ë¶„ì„í•˜ê³  ìžˆìŠµë‹ˆë‹¤.",
                "ì†ì ˆ ë¼ì¸ ê·¼ì²˜ì—ì„œ ê°€ê²©ì´ í˜•ì„±ë˜ê³  ìžˆìŠµë‹ˆë‹¤.",
                "ë³€ë™ì„±ì´ í™•ëŒ€ë˜ê³  ìžˆì–´ ë¦¬ìŠ¤í¬ ê´€ë¦¬ ë¡œì§ì´ ëŒ€ê¸° ì¤‘ìž…ë‹ˆë‹¤.",
                "ë¶€ì •ì ì¸ íë¦„ì´ ê°ì§€ë˜ì–´ ëŒ€ì‘ì„ ì¤€ë¹„ ì¤‘ìž…ë‹ˆë‹¤."
            ],
            "neutral": [
                "í˜„ìž¬ ì‹œìž¥ì€ ëšœë ·í•œ ì¶”ì„¸ê°€ ì—†ëŠ” ì¤‘ë¦½ ìƒíƒœìž…ë‹ˆë‹¤. â˜ï¸",
                "ìƒˆë¡œìš´ ì§„ìž… ê¸°íšŒë¥¼ í¬ì°©í•˜ê¸° ìœ„í•´ ì‹œìž¥ì„ ìŠ¤ìº” ì¤‘ìž…ë‹ˆë‹¤.",
                "ê´€ë§ì„¸ë¥¼ ìœ ì§€í•˜ë©° ìœ ì˜ë¯¸í•œ ë³€ë™ì„±ì„ ê¸°ë‹¤ë¦¬ê³  ìžˆìŠµë‹ˆë‹¤.",
                "ë°ì´í„° ìˆ˜ì§‘ ë° íŒ¨í„´ ë¶„ì„ì„ ì§„í–‰ ì¤‘ìž…ë‹ˆë‹¤. ðŸ“Š",
                "íŠ¹ì´ ì‚¬í•­ ì—†ì´ ì‹œìŠ¤í…œì´ ì •ìƒ ê°€ë™ ì¤‘ìž…ë‹ˆë‹¤."
            ],
            "regime_bull": [
                "ì‹œìž¥ ë°ì´í„° ë¶„ì„ ê²°ê³¼, ìƒìŠ¹ ì¶”ì„¸(Bull Market)ê°€ ìš°ì„¸í•©ë‹ˆë‹¤. ðŸ‚",
                "ë§¤ìˆ˜ ê°•ë„ê°€ ë§¤ë„ ê°•ë„ë³´ë‹¤ ë†’ê²Œ ì¸¡ì •ë˜ê³  ìžˆìŠµë‹ˆë‹¤.",
                "ì£¼ìš” ì´ë™í‰ê· ì„ ì´ ì •ë°°ì—´ ìƒíƒœë¥¼ ë³´ì´ê³  ìžˆìŠµë‹ˆë‹¤."
            ],
            "regime_bear": [
                "ì‹œìž¥ ë°ì´í„° ë¶„ì„ ê²°ê³¼, í•˜ë½ ì¶”ì„¸(Bear Market)ê°€ ìš°ì„¸í•©ë‹ˆë‹¤. ðŸ»",
                "ë³´ìˆ˜ì ì¸ ìžì‚° ìš´ìš© ê·œì¹™ì´ ì ìš©ë˜ê³  ìžˆìŠµë‹ˆë‹¤.",
                "ë³€ë™ì„± ë¦¬ìŠ¤í¬ê°€ ë†’ì•„ì ¸ ì§„ìž… ê¸°ì¤€ì´ ìƒí–¥ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
            ]
        }

    def determine_reaction(self, 
                          positions: List[object], 
                          history: List[object], 
                          thinking_log: Optional[str] = None, 
                          market_regime: str = "Neutral") -> Tuple[str, str]:
        """
        í˜„ìž¬ ìƒí™©ì„ ì¢…í•©í•˜ì—¬ ìºë¦­í„°ì˜ ê°ì •ê³¼ ëŒ€ì‚¬ë¥¼ ê²°ì •
        """
        
        # 1. Recent Event (ìµœê·¼ ë§¤ë§¤ ê²°ê³¼)
        if history and len(history) > 0:
            latest = history[0]
            try:
                roi_val = 0.0
                if hasattr(latest, 'roi'):
                    val = latest.roi
                    if isinstance(val, str):
                        val = val.replace('%', '').replace(',', '')
                    roi_val = float(val)
                
                # ê°ì •ì€ í‘œí˜„í•˜ë˜(í‘œì •), ëŒ€ì‚¬ëŠ” ë“œë¼ì´í•˜ê²Œ
                if roi_val > 5.0:
                    return "happy", self._pick("win_big")
                elif roi_val < -3.0:
                    return "sad", self._pick("loss_cut")
                
                if not thinking_log:
                    if roi_val > 0:
                        return "happy", self._pick("win_small")
                    elif roi_val < 0:
                        return "sad", self._pick("loss_cut")
                        
            except Exception:
                pass

        # 2. Thinking (AIì˜ í˜„ìž¬ ìƒê° - ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì •ì œ)
        if thinking_log:
            cleaned_log = thinking_log.replace("[Executor]", "").replace("[RiskManager]", "").strip()
            # "ë§¤ìˆ˜í•˜ì„¸ìš”" ë“±ì˜ ë‹¨ì–´ê°€ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€ í•„í„°ë§ (ê°„ë‹¨ ì²´í¬)
            if "ë§¤ìˆ˜ ì¶”ì²œ" in cleaned_log or "ì‚¬ì„¸ìš”" in cleaned_log:
                cleaned_log = "ë§¤ìˆ˜ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì–´ ì‹ í˜¸ë¥¼ ë°œìƒì‹œì¼°ìŠµë‹ˆë‹¤."
            
            return "thinking", cleaned_log

        # 3. Current Positions Status
        if positions and len(positions) > 0:
            total_roi = 0.0
            count = 0
            for p in positions:
                try:
                    val = p.roi
                    if isinstance(val, str): val = float(val.replace('%', ''))
                    total_roi += val
                    count += 1
                except: pass
            
            if count > 0:
                avg_roi = total_roi / count
                if avg_roi > 2.0:
                    return "excited", self._pick("holding_profit")
                elif avg_roi < -1.5:
                    return "worried", self._pick("holding_loss")

        # 4. Market Regime
        if market_regime == "Bull":
            return "happy", self._pick("regime_bull")
        elif market_regime == "Bear":
            return "neutral", self._pick("regime_bear")

        # 5. Default
        return "neutral", self._pick("neutral")

    def _pick(self, key: str) -> str:
        return random.choice(self.SCRIPTS.get(key, self.SCRIPTS["neutral"]))

persona_engine = PersonaEngine()
